<!-- 

File Name: map.html

Description: This file contains code to display and make
appropriate computations for team Purple Parrot's version
of the Map Project for Professor Russ Cain's Spring 2018 
CMSC447 course.

References: 

http://www.usnaviguide.com/zip.htm
https://blog.vizuri.com/how-to-create-a-choropleth-map-with-geojson-and-google-maps
https://www.data.gov/

-->

<!DOCTYPE html>
<html>
  <head>
    <title>CMSC447 Map Project</title>
    <!--<h1>
    <p style= "font-family:arial">Map Project CMSC447</p>
    </h1><br>-->
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <style>
      body {
        text-align: left;
      }
      .container { 
          width: 100%;
          height: 1000px;
          overflow: auto;
          display: block;
          position: relative;
      }
    
      .main_map{
        height: 70%;
        width: 48%;
        display: inline-block;
 
       }
      .zip_list {
        height: 35%;
        width: 40%; 
        display: inline-block;
        
      }
      .current_zip{
        height: 35%;
        width: 40%; 
        display: inline-block;
      }
      .zip_frame{
        height: 70%;
        width: 40%;
        display: inline-block;
        position: relative;
        overflow: hidden;
      }
    .modal {

        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 137px; /* Location of the box */
        left: 0;
        top: 0;
        width: 48%; /* Full width */
        height: 73%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgb(0,0,0,0.4); /* Black w/ opacity */
    }
    .modal-content {
    
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 66%;
    }
    .divider{
        width:98px;
        height:auto;
        display:inline-block;
    }
    .modal-yes{
    }
    .modal-no{
    }
    #zip-box {

        background-color: white;
        border: 1px solid black;
        bottom: 30px;
        height: 20px;
        padding: 10px;
        position: absolute;
        left: 30px;
    }
    </style>

  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

  </head>

  <body>
  <nav class="navbar navbar-expand-sm bg-light navbar-dark sticky-top">
    <ul class="nav-pills">
      <a class="nav-link" href="#">ZipCompare</a>
    </ul>
    <!--TEMPORARY-->
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <div class="divider"></div>
    <ul class="nav-pills">
      <a class="nav-link" href="#">Login</a>
    </ul>
  </nav>


  <input id="userzip" class="form-control" type="textbox" value="">
  <button type="button" onclick="resetMap()">Reset Map Zoom</button>
  <div class="divider"></div>
  <button type="button" onclick="clearModal()">Reset Zip Data</button>
  <div class="divider"></div>
  <input id="submit" type="button" value="Search for Zip Code" onclick="zipSearch()">  

  <div class="container">

    <div id="zip_modal" class="modal">

      <div class="modal-content">
        <p>Information about this zip code is displayed to the right of the map.<br>
           Would you like to add this zip code to a list, to compare it to other zip codes?</p><br>
           <button type="button" class="btn btn-primary" onclick="addtoList()">Yes</button>
           <button type="button" class="btn btn-danger" onclick="hideModal()">No</button>
      </div>

    </div>

    <div id="clear_modal" class="modal">

      <div class="modal-content">
        <p>Clear all zip code data?</p><br>
           <button type="button" onclick="clearAllZips()">Yes</button>
           <button type="button" onclick="hideModal()">No</button>
      </div>

    </div>

    <div id="clear_modal_none" class="modal">

      <div class="modal-content">
        <p>There is no data to clear.</p><br>
           <button type="button" onclick="hideModal()">Ok</button>
      </div>

    </div>

    <div class="main_map" id="main_map"><div id="click_zip"></div></div>
    

    <div class="zip_frame" id="zip_frame">
      <div class="current_zip" id="current_zip"></div><br>
      <div class="zip_list" id="zip_list"></div><br>
      <button type="button" id="compare">Compare Zip Codes</button>      
    </div>
    

  </div>

  <script>
  var main_map;
  var glob_zip;
  var new_boundary;
  var state_json;
  var zip_arr = [];
  var marker_index = 0;
  var num_zips_selected = 0;
  var zip_list_html = "No zip codes selected.";
  var zoom_recently_updated = 0;
  var hex_colors = ['#f44295','#efce94','#07ba31','#c6abcc','#f9f193','#c47105','#006600','#777777'];
  var current_color = 0;
  document.getElementById('compare').style.display = "none";
  var zoom = 5;
  var lat = 41.8375511;
  var lon = -87.6818441;
  var map = null;
  var tskey = "b300a5e050" ;

  function initMap() {

        // The zip code layer uses an ImageMapType for
        // the 
        imageMapType = new google.maps.ImageMapType({

          getTileUrl: function(coord, zoom) {

            if (zoom < 10 || zoom > 15) {

              return null;

            }

            if (zoom <= 13 ) {

              var url = "https://storage.googleapis.com/zipmap/tiles/" + zoom + "/" + coord.x + "/" + coord.y + ".png" ;       
              return url ;
      
            }
      
            var server = coord.x % 6 ;
            var url = "http://ts" + server + ".usnaviguide.com/tileserver.pl?X=" + coord.x + "&Y=" + coord.y + "&Z=" + zoom + "&T=" + tskey + "&S=Z1001" ;
            return url ;

         },
         tileSize: new google.maps.Size(256, 256),
         opacity:.5,
         name:'Zip Code'

        });
   
        var mapOptions = {

            minZoom: 4.5,
            maxZoom: 16,
            zoom: 4.5,
            center: new google.maps.LatLng(37, -95),
            mapTypeIds: google.maps.MapTypeId.ROADMAP

        };
        main_map = new google.maps.Map(document.getElementById('main_map'), mapOptions);
        main_map.overlayMapTypes.push(imageMapType);

        var state_json = new google.maps.Data();
        state_json.loadGeoJson('https://swe.umbc.edu/~dcuocci1/cmsc447project/frontEnd/us-states.json');

        state_json.setStyle(function(feature) {
 
           return {

             fillColor: stateColor(), 
             fillOpacity: 0.8,
             strokeColor: '#FFFFFF',
             strokeWeight: 1,
             zIndex: 1

           };

        });

        // Color each feature (state) in state_json a
        // different color.
        function stateColor() {

          var color = hex_colors[current_color % 8];
          current_color += 1;
          return color;

        }

        // Add the state json layer to the map.
        state_json.setMap(main_map);


        // When the user hovers, tempt them to click by outlining the letters.
        // Call revertStyle() to remove all overrides. This will use the style rules
        // defined in the function passed to setStyle()
        state_json.addListener('mouseover', function(event) {

          state_json.revertStyle();
          state_json.overrideStyle(event.feature, {strokeWeight: 2, strokeColor: '#000000',zIndex: 2});

        });

        state_json.addListener('mouseout', function(event) {

          state_json.revertStyle();

        });

        state_json.addListener('click', function(event) {

          state_json.revertStyle();

        });

        state_json.addListener('click', function(event) {

          zipZoom(event.latLng, main_map);
          
        });

        main_map.addListener('zoom_changed', function() {
 
          if(main_map.getZoom() > 9){

            // Add code to display text box with instruction to click a zip code.

            state_json.setMap(null);

          }

          else if(main_map.getZoom() < 10){

            // Add code to hide text box with instructions to click a zip code.

            state_json.setMap(main_map);

          }          

        });

  }

  function mapZoom(latLng, map) {

    var marker = new google.maps.Marker({

      position: latLng,
      map: map

    }); 

    map.setCenter(marker.getPosition());
          
    // Sets a limit for how far you can zoom in.
    if (map.getZoom() < 10) { map.setZoom(map.getZoom() + 2); }
          
    marker.setMap(null);

  }

  function zipZoom(latLng, map) {

    var center, zipcode;
    var marker = new google.maps.Marker({

      position: latLng,
      map: map

    }); 
          
    map.setCenter(marker.getPosition());
    center = map.getCenter();

    // Sets a limit for how far you can zoom in.
    map.setZoom(10);          
    marker.setMap(null);

    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({'latLng': center}, function(results, status){
          
      // Ensure the status is good.
      if (status == google.maps.GeocoderStatus.OK) {

        // Iterate through the results array to find the zip code.
        var addressComponent = results[0].address_components;            
        for (var x = 0 ; x < addressComponent.length; x++) {

          var chk = addressComponent[x];

          if (chk.types[0] == 'postal_code') {

            zipCode = chk.long_name;

          }

        }

      }

      if (zipCode) {
 
        glob_zip = zipCode;

        document.getElementById('current_zip').innerHTML = "Currently Selected Zip: " + zipCode + "<BR>" + "DISPLAY OTHER ZIP DATA HERE";

        if (num_zips_selected < 3){
                 
          var modal = document.getElementById('zip_modal');
          modal.style.display = "inline-block";

        } 
     
      }

    }); 

  } 
 
  // Reset the map to the original zoom level.
  function resetMap(){

    var myLatlng = {lat: 37, lng: -95};
    main_map.setCenter(myLatlng);
    main_map.setZoom(4.5);
    

  }

  function addtoList() {

    if (num_zips_selected < 3){

        var zip_valid = 1;
      
        // Check to ensure the zip code
        // is not a duplicate.
        for (var i = 0; i < 3; i++){

            if (zip_arr[i] == glob_zip) {

              zip_valid = 0;

            }
        }

        if(zip_valid){

          // Add the zip code to the array, and increment
          // the number of zip codes there.
          zip_arr[num_zips_selected] = glob_zip;           
          num_zips_selected = num_zips_selected + 1;
           
          zip_list_html = "Zip Code Comparison List (3 max): <br> <br>";
         
          // Add the zip codes in the list to the html string.
          for (i = 0; i < num_zips_selected; i++){

            zip_list_html = zip_list_html + zip_arr[i] + "<br>";

          }

          document.getElementById('zip_list').innerHTML = zip_list_html;
             
        }

    }

    // This doesn't work just yet.
    if (num_zips_selected > 1){

      zip_list_html = document.getElementById('zip_list').innerHTML + "<br>" + "<br>" + "This button doesn't work yet.";
      document.getElementById('compare').style.display = "inline-block";
        
    }  

    hideModal();
    main_map.data.setStyle({
 
        fillColor: 'green'

    }); 

  } 

  // Zoom the map based on the zip code entered.
  function zipSearch(){

    var geocoder = new google.maps.Geocoder;

    // Grab the zip code entered by the user.
    var address = document.getElementById("userzip").value;

    // Run the Google geocoding function.
    // Converts the zip code entered to a lat and long.
    geocoder.geocode({'address': address}, function(results, status) {

      // If successful, make a call to zipZoom.
      if (status === 'OK') {

        zipZoom(results[0].geometry.location, main_map);
 
      }
 
      else {

        alert('Geocode was not successful for the following reason: ' + status);

      }

    });

  } 



  // Closes the modal window.
  function hideModal(){

    document.getElementById('zip_modal').style.display = "none";
    document.getElementById('clear_modal').style.display = "none";
    document.getElementById('clear_modal_none').style.display = "none";

  }

  // Handles the display of the appropriate modal
  // given the number of zip codes entered so far.
  function clearModal(){

    var modal;

    if (num_zips_selected === 0){ 

      modal = document.getElementById('clear_modal_none');
      modal.style.display = "inline-block";

    }

    else {

      modal = document.getElementById('clear_modal');
      modal.style.display = "inline-block";

    }

  }

  // Clear out any data the user may have entered so far.
  function clearAllZips(){

      document.getElementById('current_zip').innerHTML = "";
      document.getElementById('zip_list').innerHTML = "No zip codes selected.";
      document.getElementById('compare').style.display = "none";
      num_zips_selected = 0;

      hideModal();

  }

  </script>
  <script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlbhFBE6Pe-UpthT8KqrlXTIt91_9qgPc&callback=initMap">
  </script>
  
  </body>
</html>
